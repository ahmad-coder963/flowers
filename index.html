<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø­Ø¯ÙŠÙ‚Ø© Ù„Ø¬ÙŠÙ†ğŸŒ·</title>
  <style>
    :root{
      --bg:#ffeaf2; --panel:#fff7fb; --text:#2b2443; --muted:#7a6d8a;
      --stroke:#f2c6d8; --accent:#ff8ab3; --accent2:#ffb6cc; --good:#1aa865; --bad:#ff4f7a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial; background:radial-gradient(1200px 600px at 70% -10%, #ffd6e7 0%, transparent 60%), var(--bg); color:var(--text)}

    header{position:sticky; top:0; z-index:5; display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px 16px; background:linear-gradient(180deg, rgba(255,234,242,.95), rgba(255,234,242,.6) 60%, transparent); border-bottom:1px solid var(--stroke); backdrop-filter: blur(6px)}
    .title{display:flex; align-items:center; gap:10px; font-weight:900}
    .title .logo{font-size:26px}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .btn{background:linear-gradient(180deg, #ffdceb, #ffd3e6); border:1px solid #f2b9cf; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; transition:.15s transform,.15s box-shadow; font-weight:800; display:flex; align-items:center; gap:8px}
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.1)}
    .btn.active{outline:2px solid var(--accent); box-shadow:0 0 0 6px rgba(255,138,179,.12) inset}
    .btn.small{padding:8px 10px; font-size:14px}

    .wrap{display:grid; grid-template-columns:320px 1fr 360px; gap:16px; padding:16px; max-width:1300px; margin:0 auto}
    .panel{background:linear-gradient(180deg, #fff9fc, #ffedf4); border:1px solid var(--stroke); border-radius:16px; padding:14px}
    .panel h3{margin:6px 0 12px; color:#513a62; font-size:16px}

    .legend{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; margin-top:6px}
    .opt{display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--stroke); border-radius:12px; cursor:pointer; background:linear-gradient(180deg,#fff, #fff4f8)}
    .opt.active{outline:2px solid var(--accent2); box-shadow:0 0 0 6px rgba(255,182,204,.16) inset}
    .name{font-weight:900}

    .garden{display:grid; grid-template-columns:repeat(6, 1fr); gap:10px; padding:12px; background:linear-gradient(180deg,#ffe9f3,#ffe2ef); border:1px dashed #f2b9cf; border-radius:16px}
    .plot{min-height:110px; border-radius:14px; background:radial-gradient(circle at 50% 30%, #8a5c3b 0%, #6e472c 45%, #58351d 70%); border:1px solid #a3764f; position:relative; overflow:hidden; cursor:pointer; display:flex; align-items:center; justify-content:center}
    .plot.empty{opacity:.95}
    .plot .waterbar{position:absolute; left:8px; right:8px; top:8px; height:8px; border-radius:99px; background:#ffd3e6; border:1px solid #f2b9cf; overflow:hidden}
    .plot .waterbar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, #ffb6cc, #ff8ab3); transition:width .3s ease}
    .plot .label{position:absolute; top:20px; left:0; right:0; text-align:center; font-size:12px; color:#4e3f63}
    .seed{position:absolute; bottom:10px; font-size:20px; opacity:.9}
    .sprout{position:absolute; bottom:10px; font-size:24px}
    .bud{position:absolute; bottom:12px; font-size:26px}
    .bloom{position:absolute; bottom:12px; font-size:30px; filter:drop-shadow(0 2px 6px rgba(255,255,255,.25))}

    .inv{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    .card{background:linear-gradient(180deg,#fff7fb,#ffedf4); border:1px solid #f2c6d8; border-radius:14px; padding:10px; display:flex; align-items:center; justify-content:space-between}
    .qty{background:#ffe3ee; border:1px solid #f9c5Ø¯7; padding:2px 8px; border-radius:999px; font-weight:800; color:#7b2e4a}

    .bouquet{display:grid; grid-template-rows:auto auto 1fr auto; gap:10px}
    .bouquet-canvas{height:360px; border-radius:20px; border:1px solid #f2b9cf; background:radial-gradient(800px 360px at 50% -10%, #ffd6e7 0%, #ffe9f3 65%); display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden}
    .bouquet-canvas .glow{position:absolute; inset:-20%; background:radial-gradient(ellipse at 50% 0%, rgba(255,182,204,.18), transparent 60%); pointer-events:none}
    .bouquet-canvas svg{width:100%; height:100%; display:block}

    .flowers{display:none}

    .bouquet-controls{display:grid; grid-template-columns:repeat(4, 1fr); gap:8px}
    .hint{color:var(--muted); font-size:13px}
    .badge{background:#ffe7f0; border:1px solid #f4c2d6; color:#6a3e57; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800}
    .sep{height:1px; background:linear-gradient(90deg, transparent, #f2c6d8, transparent); margin:10px 0}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    footer{text-align:center; color:#7a6d8a; padding:18px 8px}

    /* ØªØ¬Ø§ÙˆØ¨ */
    @media (max-width: 1100px){ .wrap{ grid-template-columns:1fr 1fr; } }
    @media (max-width: 800px){ header{flex-wrap:wrap; gap:8px} .wrap{grid-template-columns:1fr} .garden{grid-template-columns:repeat(3,1fr)} .bouquet-canvas{height:300px} .btn{padding:12px 16px; border-radius:14px} .toolbar .btn{flex:1} }
    @media (max-width: 520px){ .garden{grid-template-columns:repeat(2,1fr)} .plot{min-height:120px} .bouquet-canvas{height:260px} .legend{grid-template-columns:1fr} .inv{grid-template-columns:1fr} .toolbar{gap:6px} .toolbar .btn{min-width:calc(50% - 6px)} }
  </style>
</head>
<body>
  <header>
    <div class="title"><span class="logo">ğŸŒ¸</span>Ø­Ø¯ÙŠÙ‚Ø© Ù„Ø¬ÙŠÙ†</div>
    <div class="toolbar">
      <button class="btn small" id="tool-plant">ğŸŒ± Ø²Ø±Ø¹</button>
      <button class="btn small" id="tool-water">ğŸ’§ Ø³Ù‚ÙŠ</button>
      <button class="btn small" id="tool-harvest">âœ‚ï¸ Ø­ØµØ§Ø¯</button>
      <button class="btn small" id="tool-shovel">ğŸª“ Ø¥Ø²Ø§Ù„Ø©</button>
      <span class="badge" id="status">ÙˆØ¶Ø¹: Ø²Ø±Ø¹</span>
    </div>
  </header>

  <main class="wrap">
    <!-- ÙŠÙ…ÙŠÙ†: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† -->
    <section class="panel" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹">
      <h3>Ù¡) Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø²Ù‡Ø±Ø© Ù„Ù„Ø¨Ø°Ø±Ø©</h3>
      <div class="legend" id="flowerTypes"></div>
      <div class="sep"></div>
      <p class="hint">Ø§Ø¶ØºØ· Ø£ÙŠ Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ© Ù„Ø²Ø±Ø¹ Ø§Ù„Ø¨Ø°Ø±Ø©ØŒ Ø§Ø³Ù‚Ù 3 Ù…Ø±Ø§Øª Ø­ØªÙ‰ ØªØ²Ù‡Ø±ØŒ Ø«Ù… Ø§Ø­ØµØ¯ Ù„ØªØ¬Ù…Ø¹ Ø§Ù„Ø²Ù‡ÙˆØ±.</p>
      <div class="sep"></div>
      <h3>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø§Ù„Ù…Ø­ØµÙˆÙ„)</h3>
      <div class="inv" id="inventory"></div>
    </section>

    <!-- ÙˆØ³Ø·: Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø© -->
    <section class="panel" aria-label="Ø­Ø¯ÙŠÙ‚Ø©">
      <h3>Ù¢) Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©</h3>
      <div class="garden" id="garden" aria-live="polite">
        <!-- Fallback Ø«Ø§Ø¨Øª ÙŠØ¸Ù‡Ø± Ø­ØªÙ‰ Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
        <div class="plot empty"><div class="waterbar"><span></span></div><span class="seed" style="opacity:.35">â€”</span><div class="label">Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©</div></div>
      </div>
      <div class="sep"></div>
      <div class="flex">
        <div class="badge">ÙƒÙ„ Ù†Ø¨ØªØ© ØªØ­ØªØ§Ø¬ 3 Ù…Ø±Ø§Øª Ø³Ù‚ÙŠ Ù„ØªØ²Ù‡Ø± ğŸŒ§ï¸</div>
        <div class="grow"></div>
        <button class="btn small" id="btn-fill">Ù…Ù„Ø¡ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§</button>
        <button class="btn small" id="btn-clear">Ù…Ø³Ø­ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©</button>
      </div>
    </section>

    <!-- ÙŠØ³Ø§Ø±: Ø§Ù„Ø¨ÙˆÙƒÙŠÙ‡ -->
    <section class="panel" aria-label="Ø¨ÙˆÙƒÙŠÙ‡">
      <h3>Ù£) Ø§ØµÙ†Ø¹ Ø¨ÙˆÙƒÙŠÙ‡ Ø§Ù„ÙˆØ±Ø¯ (Ù…Ù„ÙÙˆÙ)</h3>
      <div class="bouquet">
        <div class="bouquet-canvas" id="bouquetCanvas">
          <div class="glow"></div>
          <svg id="bouquetSvg" viewBox="0 0 400 360" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙˆÙƒÙŠÙ‡"></svg>
        </div>
        <div class="bouquet-controls" id="bouquetControls"></div>
        <div class="flex">
          <input class="btn grow" id="bouquetName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆÙƒÙŠÙ‡" />
          <button class="btn" id="makeBouquet">ğŸ’ Ø£Ù†Ø´Ø¦ Ø§Ù„Ø¨ÙˆÙƒÙŠÙ‡</button>
          <button class="btn" id="exportPng">ğŸ“¸ ØªØµØ¯ÙŠØ± ÙƒØµÙˆØ±Ø©</button>
        </div>
        <div class="hint" id="bouquetStat">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙˆÙƒÙŠÙ‡ Ø¨Ø¹Ø¯.</div>
      </div>
    </section>
  </main>

  <footer>Made by Ahmed especially for lujainğŸ¤ </footer>

  <script>
  // ÙƒÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ØªØ¬Ù†Ù‘Ø¨ Ø£Ø®Ø·Ø§Ø¡ null
  document.addEventListener('DOMContentLoaded', () => {
    // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø²Ù‡ÙˆØ±
    const FLOWERS = [
      { id:'rose',  name:'ÙˆØ±Ø¯Ø©',        emoji:'ğŸŒ¹', waters:3 },
      { id:'tulip', name:'ØªÙˆÙ„ÙŠØ¨',       emoji:'ğŸŒ·', waters:3 },
      { id:'sun',   name:'Ø¯ÙˆÙ‘Ø§Ø± Ø§Ù„Ø´Ù…Ø³', emoji:'ğŸŒ»', waters:3 },
      { id:'daisy', name:'Ø£Ù‚Ø­ÙˆØ§Ù†',      emoji:'ğŸŒ¼', waters:3 },
    ];
    const TOOLS = { PLANT:'Ø²Ø±Ø¹', WATER:'Ø³Ù‚ÙŠ', HARVEST:'Ø­ØµØ§Ø¯', SHOVEL:'Ø¥Ø²Ø§Ù„Ø©' };

    const state = {
      tool:'PLANT',
      selected:'rose',
      plots: Array.from({length:18},()=>({empty:true})),
      inventory: Object.fromEntries(FLOWERS.map(f=>[f.id,0])),
      bouquet: Object.fromEntries(FLOWERS.map(f=>[f.id,0]))
    };

    const el = {
      types: document.getElementById('flowerTypes'),
      garden: document.getElementById('garden'),
      inv: document.getElementById('inventory'),
      status: document.getElementById('status'),
      bouquetControls: document.getElementById('bouquetControls'),
      bouquetName: document.getElementById('bouquetName'),
      bouquetStat: document.getElementById('bouquetStat'),
      bouquetSvg: document.getElementById('bouquetSvg'),
      bouquetCanvas: document.getElementById('bouquetCanvas'),
      btnPlant: document.getElementById('tool-plant'),
      btnWater: document.getElementById('tool-water'),
      btnHarvest: document.getElementById('tool-harvest'),
      btnShovel: document.getElementById('tool-shovel'),
      btnFill: document.getElementById('btn-fill'),
      btnClear: document.getElementById('btn-clear'),
      btnExport: document.getElementById('exportPng'),
      btnMake: document.getElementById('makeBouquet'),
    };

    // --- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªØ´ØºÙŠÙ„ Ù…Ø¨ÙƒÙ‘Ø±Ø© (test cases) ---
    console.assert(!!el.btnPlant, '#tool-plant ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¬Ø¯');
    console.assert(!!el.garden, '#garden ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¬Ø¯');
    console.assert(!!el.bouquetSvg, '#bouquetSvg ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¬Ø¯');
    console.assert(Array.isArray(FLOWERS) && FLOWERS.length===4, 'ÙŠØ¬Ø¨ ÙˆØ¬ÙˆØ¯ 4 Ø£Ù†ÙˆØ§Ø¹ Ø²Ù‡ÙˆØ±');

    // ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
    function renderTypes(){
      el.types.innerHTML = '';
      FLOWERS.forEach(f=>{
        const opt = document.createElement('button');
        opt.className = 'opt' + (state.selected===f.id ? ' active' : '');
        opt.innerHTML = `<span style="font-size:20px">${f.emoji}</span><div><div class="name">${f.name}</div><div class="hint">ÙŠØ³Ù‚Ù‰ ${f.waters} Ù…Ø±Ø§Øª</div></div>`;
        opt.onclick = ()=>{ state.selected=f.id; renderTypes(); };
        el.types.appendChild(opt);
      });
    }

    // Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©
    function renderGarden(){
      el.garden.innerHTML = '';
      state.plots.forEach((p,i)=>{
        const cell = document.createElement('div');
        cell.className = 'plot' + (p.empty?' empty':'');
        const bar = document.createElement('div'); bar.className='waterbar';
        const prog = document.createElement('span'); bar.appendChild(prog);
        const lb = document.createElement('div'); lb.className='label';

        if(p.empty){
          lb.textContent='Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ ÙØ§Ø±ØºØ©';
          const placeholder=document.createElement('span'); placeholder.className='seed'; placeholder.style.opacity='.35'; placeholder.textContent='â€”';
          cell.appendChild(bar); cell.appendChild(placeholder); cell.appendChild(lb);
        } else {
          const f = FLOWERS.find(x=>x.id===p.type);
          const stage = p.stage||0; const water = p.water||0;
          prog.style.width = Math.min(100, (water / f.waters)*100) + '%';
          let contentEl = document.createElement('span');
          if(stage===0){ contentEl.className='seed';  contentEl.textContent='ğŸŸ¤'; lb.textContent = `${f.name} â€” Ø¨Ø°Ø±Ø©`; }
          if(stage===1){ contentEl.className='sprout';contentEl.textContent='ğŸŒ±'; lb.textContent = `${f.name} â€” Ù†Ø¨ØªØ©`; }
          if(stage===2){ contentEl.className='bud';   contentEl.textContent='ğŸŒ¿'; lb.textContent = `${f.name} â€” Ø¨Ø±Ø¹Ù…`; }
          if(stage===3){ contentEl.className='bloom'; contentEl.textContent=f.emoji; lb.textContent = `${f.name} â€” Ø²Ù‡Ø±Ø© Ø¬Ø§Ù‡Ø²Ø©`; }
          cell.appendChild(bar); cell.appendChild(contentEl); cell.appendChild(lb);
        }

        cell.addEventListener('click', ()=>{
          const p = state.plots[i];
          if(state.tool==='PLANT' && p.empty){
            const f = FLOWERS.find(x=>x.id===state.selected);
            state.plots[i] = { empty:false, type:f.id, stage:0, water:0 }; sfx('plant'); saveState(); renderGarden();
          } else if(state.tool==='WATER' && !p.empty){
            const f = FLOWERS.find(x=>x.id===p.type);
            if(p.stage<3){ p.water = Math.min((p.water||0)+1, f.waters); if(p.water >= (p.stage+1)) p.stage = Math.min(3, p.stage+1); }
            sfx('water'); saveState(); renderGarden();
          } else if(state.tool==='HARVEST' && !p.empty){
            if(p.stage<3){ flashPlot(i,'Ù„Ù… ÙŠØ²Ù‡Ø± Ø¨Ø¹Ø¯ ğŸŒ±'); return; }
            const f = FLOWERS.find(x=>x.id===p.type);
            const extra = Math.random()<0.35 ? 1 : 0;
            state.inventory[f.id] += 1 + extra; sfx('harvest');
            state.plots[i] = { empty:true }; saveState();
            renderGarden(); renderInventory();
          } else if(state.tool==='SHOVEL' && !p.empty){
            state.plots[i] = { empty:true }; sfx('shovel'); saveState(); renderGarden();
          }
        });

        el.garden.appendChild(cell);
      });
    }

    function flashPlot(i, txt){
      const card = el.garden.children[i]; if(!card) return; card.style.boxShadow='0 0 0 3px rgba(255,79,122,.35) inset'; card.title=txt; setTimeout(()=>{ card.style.boxShadow=''; card.title=''; }, 500);
    }

    function renderInventory(){
      el.inv.innerHTML = '';
      FLOWERS.forEach(f=>{
        const card = document.createElement('div'); card.className='card';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-size:20px">${f.emoji}</div><div class="hint">${f.name}</div>`;
        const right = document.createElement('div'); right.innerHTML = `<span class="qty">x ${state.inventory[f.id]}</span>`;
        card.appendChild(left); card.appendChild(right); el.inv.appendChild(card);
      });
    }

    // Ø£Ø¯ÙˆØ§Øª
    function setTool(t){
      state.tool = t; document.querySelectorAll('.toolbar .btn').forEach(b=>b.classList.remove('active'));
      const map = {PLANT:'#tool-plant', WATER:'#tool-water', HARVEST:'#tool-harvest', SHOVEL:'#tool-shovel'};
      const target = document.querySelector(map[t]); if(target) target.classList.add('active');
      el.status.textContent = `ÙˆØ¶Ø¹: ${TOOLS[t]}`;
    }
    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ù…Ø­Ù…ÙŠ Ù…Ù† null)
    el.btnPlant && (el.btnPlant.onclick = ()=>setTool('PLANT'));
    el.btnWater && (el.btnWater.onclick = ()=>setTool('WATER'));
    el.btnHarvest && (el.btnHarvest.onclick = ()=>setTool('HARVEST'));
    el.btnShovel && (el.btnShovel.onclick = ()=>setTool('SHOVEL'));

    // Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙˆÙƒÙŠÙ‡
    function renderBouquetControls(){
      el.bouquetControls.innerHTML = '';
      FLOWERS.forEach(f=>{
        const wrap = document.createElement('div'); wrap.className='flex'; wrap.style.border='1px solid var(--stroke)'; wrap.style.borderRadius='12px'; wrap.style.padding='8px'; wrap.style.background='linear-gradient(180deg,#fff,#fff4f8)';
        wrap.innerHTML = `<div style=\"font-size:20px\">${f.emoji}</div><div class=\"grow hint\">${f.name}</div>`;
        const minus = document.createElement('button'); minus.className='btn small'; minus.textContent='âˆ’';
        const plus  = document.createElement('button'); plus.className='btn small'; plus.textContent='+';
        const cnt   = document.createElement('span'); cnt.className='qty'; cnt.textContent='0';
        minus.onclick = ()=>{ changeBouquet(f.id, -1); cnt.textContent = state.bouquet[f.id]; };
        plus.onclick  = ()=>{ changeBouquet(f.id, +1); cnt.textContent = state.bouquet[f.id]; };
        wrap.appendChild(minus); wrap.appendChild(cnt); wrap.appendChild(plus);
        el.bouquetControls.appendChild(wrap);
      });
    }

    function changeBouquet(id, delta){
      const have = state.inventory[id]; const want = state.bouquet[id] + delta;
      if(want < 0) return; if(delta>0 && want > have){ toast('Ù„Ø§ ØªÙ…Ù„Ùƒ Ù…Ø§ ÙŠÙƒÙÙŠ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø²Ù‡Ø±Ø©'); return; }
      state.bouquet[id] = want; updateBouquetCanvas(); saveState();
    }

    el.btnMake && (el.btnMake.onclick = ()=>{
      const total = Object.values(state.bouquet).reduce((a,b)=>a+b,0);
      if(total<1){ toast('Ø£Ø¶Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø²Ù‡ÙˆØ± Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆÙƒÙŠÙ‡ Ø£ÙˆÙ„Ù‹Ø§'); return; }
      for(const f of FLOWERS){ if(state.bouquet[f.id] > state.inventory[f.id]){ toast('Ø§Ù„Ø¨ÙˆÙƒÙŠÙ‡ ÙŠØ­ØªØ§Ø¬ Ø²Ù‡ÙˆØ± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø®Ø²ÙˆÙ†Ùƒ'); return; } }
      for(const f of FLOWERS){ state.inventory[f.id] -= state.bouquet[f.id]; }
      renderInventory(); const name = el.bouquetName.value.trim() || 'Ø¨ÙˆÙƒÙŠÙ‡ Ø¨Ù„Ø§ Ø§Ø³Ù…';
      el.bouquetStat.innerHTML = `<span style=\"color:${getComputedStyle(document.documentElement).getPropertyValue('--good').trim()}\">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ \"${name}\"</span> â€” ØªØ¨Ø¯Ùˆ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø£Ù†ÙŠÙ‚Ø© ÙˆÙ…Ù„ÙÙˆÙØ© ğŸ€`;
      el.bouquetCanvas.animate([{transform:'scale(1)'},{transform:'scale(1.02)'},{transform:'scale(1)'}],{duration:420, easing:'ease-out'});
      state.bouquet = Object.fromEntries(FLOWERS.map(f=>[f.id,0])); updateBouquetCanvas(); renderBouquetControls(); saveState();
    });

    // ØµÙˆØªÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© (WebAudio)
    let AudioCtx; function sfx(kind){
      try{ AudioCtx = AudioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const o = AudioCtx.createOscillator(); const g = AudioCtx.createGain();
        o.connect(g); g.connect(AudioCtx.destination);
        const now = AudioCtx.currentTime; let f=600;
        if(kind==='water') f=420; if(kind==='harvest') f=320; if(kind==='shovel') f=240; if(kind==='plant') f=500;
        o.frequency.setValueAtTime(f, now); o.frequency.exponentialRampToValueAtTime(180, now+0.12);
        g.gain.setValueAtTime(0.12, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.15);
        o.start(now); o.stop(now+0.16);
      }catch(e){}
    }

    // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    function saveState(){ const data = {plots:state.plots, inventory:state.inventory, bouquet:state.bouquet, selected:state.selected}; localStorage.setItem('flowerGamePink', JSON.stringify(data)); }
    function loadState(){
      try{
        const raw = localStorage.getItem('flowerGamePink');
        if(!raw){
          // Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„: Ø§Ø¨Ø¯Ø£ Ø¨Ø­Ø¯ÙŠÙ‚Ø© ÙØ§Ø¶ÙŠØ© ØªÙ…Ø§Ù…Ù‹Ø§ Ø«Ù… Ø§Ø­ÙØ¸Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
          state.plots = Array.from({length:18},()=>({empty:true}));
          state.inventory = Object.fromEntries(FLOWERS.map(f=>[f.id,0]));
          state.bouquet = Object.fromEntries(FLOWERS.map(f=>[f.id,0]));
          state.selected = 'rose';
          localStorage.setItem('flowerGamePink:firstRun','done');
          saveState();
          return { firstRun:true };
        }
        const d = JSON.parse(raw);
        if(d.plots && Array.isArray(d.plots)) state.plots = d.plots; 
        if(d.inventory) state.inventory = d.inventory; 
        if(d.bouquet) state.bouquet = d.bouquet; 
        if(d.selected) state.selected = d.selected; 
        return { firstRun:false };
      }catch(e){
        console.warn('loadState error', e);
        return { firstRun:false };
      }
    }

    // ===== SVG bouquet rendering =====
    function svgEl(name, attrs){ const e = document.createElementNS('http://www.w3.org/2000/svg', name); for(const k in attrs){ e.setAttribute(k, attrs[k]); } return e; }
    function drawStem(g, x1, y1, x2, y2){ const d = `M${x1},${y1} Q ${(x1+x2)/2},${(y1+y2)/2+20} ${x2},${y2}`; g.appendChild(svgEl('path', { d, stroke:'#7ac9a3', 'stroke-width':'3', fill:'none', 'stroke-linecap':'round' })); g.appendChild(svgEl('path', { d, stroke:'#c9efd8', 'stroke-width':'1.2', fill:'none', 'stroke-linecap':'round', opacity:'.5' })); }
    function drawRose(g, x, y){
      // ÙˆØ±Ø¯Ø© Ø­Ù…Ø±Ø§Ø¡ Ù…Ø­Ø³Ù†Ø©
      const grp = svgEl('g', {transform:`translate(${x} ${y})`});
      grp.appendChild(svgEl('circle',{cx:0, cy:0, r:3.6, fill:'#8b1232'}));
      const petals = [
        {r:17, k:1.0, c:'#ff6b8a', s:'#e85377'},
        {r:14, k:0.92, c:'#ff7d99', s:'#ef5b82'},
        {r:11, k:0.86, c:'#ff93aa', s:'#f17395'}
      ];
      petals.forEach((p, ring)=>{
        for(let i=0;i<6;i++){
          const a = (i*60) + (ring*8);
          const path = svgEl('path', {
            d: `M0,0 C ${p.r*p.k},${-p.r*0.6} ${p.r*0.6},${-p.r*0.1} ${p.r},0 C ${p.r*0.6},${p.r*0.1} ${p.r*p.k},${p.r*0.6} 0,0`,
            fill: p.c, stroke: p.s, 'stroke-width': 0.8, opacity: 0.95,
            transform: `rotate(${a}) translate(${p.r*0.25} 0)`
          });
          grp.appendChild(path);
        }
      });
      grp.appendChild(svgEl('ellipse',{cx:-2, cy:-2, rx:6, ry:3, fill:'rgba(255,255,255,0.18)', transform:'rotate(-25)'}));
      g.appendChild(grp);
    }
    function drawTulip(g, x, y){ const grp = svgEl('g', {transform:`translate(${x} ${y})`}); grp.appendChild(svgEl('path',{d:'M-10,0 Q0,-18 10,0 Q0,14 -10,0 Z', fill:'#ff9ec0'})); grp.appendChild(svgEl('path',{d:'M-10,0 Q0,-10 10,0', fill:'none', stroke:'#ff7fb0','stroke-width':'2'})); g.appendChild(grp); }
    function drawSun(g, x, y){ const grp = svgEl('g', {transform:`translate(${x} ${y})`}); for(let i=0;i<12;i++){ grp.appendChild(svgEl('rect',{x:-2, y:-22, width:4, height:10, fill:'#ffe08a', transform:`rotate(${i*30})`})); } grp.appendChild(svgEl('circle',{cx:0, cy:0, r:10, fill:'#ffd166', stroke:'#e3b94d'})); grp.appendChild(svgEl('circle',{cx:0, cy:0, r:4, fill:'#826f2a'})); g.appendChild(grp); }
    function drawDaisy(g, x, y){ const grp = svgEl('g', {transform:`translate(${x} ${y})`}); for(let i=0;i<12;i++){ grp.appendChild(svgEl('ellipse',{cx:0, cy:0, rx:8, ry:3.8, fill:'#fff', opacity:'.95', transform:`rotate(${i*30}) translate(9 0)`})); } grp.appendChild(svgEl('circle',{cx:0, cy:0, r:5, fill:'#f2cf5b'})); g.appendChild(grp); }
    function drawPaperAndRibbon(svg){ const paper = svgEl('path',{ d:'M200 40 L330 170 Q200 340 200 340 Q200 340 70 170 Z', fill:'#ffe9f3', stroke:'#f2c6d8','stroke-width':'2'}); const shadow= svgEl('path',{ d:'M200 40 L330 170 Q200 340 200 340', fill:'none', stroke:'rgba(0,0,0,.12)','stroke-width':'14'}); const ribbonTop = svgEl('path',{ d:'M150 200 Q200 220 250 200', fill:'none', stroke:'#ff98b3', 'stroke-width':'12','stroke-linecap':'round'}); const knot = svgEl('circle',{cx:200, cy:204, r:7, fill:'#ff7aa5'}); const bowL = svgEl('path',{ d:'M195 204 q-26 10 -26 30 q18 -12 26 -20 z', fill:'#ff98b3'}); const bowR = svgEl('path',{ d:'M205 204 q26 10 26 30 q-18 -12 -26 -20 z', fill:'#ff98b3'}); svg.appendChild(paper); svg.appendChild(shadow); svg.appendChild(ribbonTop); svg.appendChild(knot); svg.appendChild(bowL); svg.appendChild(bowR); }
    function drawBouquet(){
      const svg = el.bouquetSvg; while(svg.firstChild) svg.removeChild(svg.firstChild);
      // defs Ù„ÙØªØ¯Ø±Ø¬Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
      const defs = svgEl('defs',{});
      const grad = svgEl('linearGradient',{id:'petalGrad', x1:'0', y1:'0', x2:'0', y2:'1'});
      grad.appendChild(svgEl('stop',{offset:'0%', 'stop-color':'#fff', 'stop-opacity':'0.15'}));
      grad.appendChild(svgEl('stop',{offset:'100%', 'stop-color':'#fff', 'stop-opacity':'0'}));
      defs.appendChild(grad);
      svg.appendChild(defs);

      drawPaperAndRibbon(svg);
      const stems = svgEl('g'); svg.appendChild(stems);
      const flowers = svgEl('g'); svg.appendChild(flowers);
      const items=[]; FLOWERS.forEach(f=>{ for(let i=0;i<state.bouquet[f.id];i++){ items.push(f.id); } });
      if(items.length===0){ return; }
      items.sort((a,b)=> (a==='sun'? -1:0) - (b==='sun'? -1:0));
      const cx=200, cy=150; const golden = Math.PI*(3-Math.sqrt(5));
      items.forEach((type,i)=>{
        const r = 12 + Math.sqrt(i+1)*16; const angle = i*golden;
        const x = cx + Math.cos(angle)*r*0.95; const y = cy + Math.sin(angle)*r*0.8 - Math.min(i*0.35, 20);
        drawStem(stems, 200, 240, x, y+10);
        if(type==='rose') drawRose(flowers,x,y);
        if(type==='tulip') drawTulip(flowers,x,y);
        if(type==='sun') drawSun(flowers,x,y);
        if(type==='daisy') drawDaisy(flowers,x,y);
      });
    }
    function updateBouquetCanvas(){ drawBouquet(); }
    window.addEventListener('resize', ()=>{ updateBouquetCanvas(); });

    // Ø£Ø²Ø±Ø§Ø± Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©
    el.btnClear && (el.btnClear.onclick = ()=>{ state.plots = state.plots.map(()=>({empty:true})); saveState(); renderGarden(); });
    el.btnFill && (el.btnFill.onclick = ()=>{ state.plots = state.plots.map(()=>{ const f = FLOWERS[Math.floor(Math.random()*FLOWERS.length)]; return { empty:false, type:f.id, stage:0, water:0 }; }); saveState(); renderGarden(); });

    // Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ±
    let toastT=null; function toast(msg){ clearTimeout(toastT); let box=document.getElementById('toast'); if(!box){ box=document.createElement('div'); box.id='toast'; document.body.appendChild(box); Object.assign(box.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',background:'#fff0f5',border:'1px solid #f2b9cf',padding:'10px 14px',borderRadius:'12px',color:'#6a3e57',fontWeight:'800',zIndex:99,boxShadow:'0 10px 30px rgba(0,0,0,.12)'});} box.textContent=msg; box.style.opacity='1'; toastT=setTimeout(()=>{ box.style.opacity='0'; }, 1600); }

    // === ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© PNG Ù…Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© ===
    function exportBouquetPNG(){
      const svg = el.bouquetSvg; if(!svg){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
      const box = el.bouquetCanvas.getBoundingClientRect();
      const w = Math.max(400, Math.round(box.width));
      const h = Math.max(360, Math.round(box.height));
      const baseDPR = (w < 520 ? 1.5 : 2);
      const scale = Math.min(3, Math.max(baseDPR, (window.devicePixelRatio||2)));
      const cw = Math.round(w*scale), ch = Math.round(h*scale);
      const canvas = document.createElement('canvas'); canvas.width=cw; canvas.height=ch; const ctx = canvas.getContext('2d');
      // Ø®Ù„ÙÙŠØ© ÙˆØ±Ø¯ÙŠØ© + ØªÙˆÙ‡Ø¬ Ù…Ø«Ù„ CSS
      ctx.fillStyle = '#ffe9f3'; ctx.fillRect(0,0,cw,ch);
      const cxg = cw*0.5, cyg = -ch*0.1; const rg = ch*0.9;
      const grad = ctx.createRadialGradient(cxg, cyg, 0, cxg, cyg, rg);
      grad.addColorStop(0, '#ffd6e7'); grad.addColorStop(0.65, '#ffe9f3'); grad.addColorStop(1, '#ffe9f3');
      ctx.fillStyle = grad; ctx.fillRect(0,0,cw,ch);
      const gx = cw*0.5, gy = ch*0.05, gr = Math.max(cw,ch)*0.7;
      const glow = ctx.createRadialGradient(gx, gy, 0, gx, gy, gr);
      glow.addColorStop(0, 'rgba(255,182,204,0.18)'); glow.addColorStop(1, 'rgba(255,182,204,0)');
      ctx.fillStyle = glow; ctx.fillRect(0,0,cw,ch);
      // Ø±Ø³Ù… SVG ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ©
      const clone = svg.cloneNode(true);
      clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
      const xml = new XMLSerializer().serializeToString(clone);
      const blob = new Blob([xml], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = ()=>{ ctx.drawImage(img, 0, 0, cw, ch); URL.revokeObjectURL(url); const a = document.createElement('a'); a.href = canvas.toDataURL('image/png'); a.download = (el.bouquetName.value.trim() || 'bouquet') + '.png'; document.body.appendChild(a); a.click(); a.remove(); toast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© âœ…'); };
      img.onerror = ()=>{ URL.revokeObjectURL(url); toast('ØªØ¹Ø°Ù‘Ø± ØªØµØ¯ÙŠØ± SVG'); };
      img.src = url;
    }
    el.btnExport && el.btnExport.addEventListener('click', exportBouquetPNG);

    // ØªØ­Ù…ÙŠÙ„ Ø«Ù… ØªÙ‡ÙŠØ¦Ø©
    function init(){
      const info = loadState();
      renderTypes();
      renderGarden();
      renderInventory();
      renderBouquetControls();
      updateBouquetCanvas();
      setTool('PLANT');
      window.__firstRun = !!info.firstRun;
      if(window.__firstRun){ console.info('First run: garden starts empty.'); }
    }
    try{ init(); }catch(err){
      console.error('Init failed:', err);
      const warn = document.createElement('div');
      warn.style.cssText='position:fixed;left:50%;top:10px;transform:translateX(-50%);background:#fff0f5;border:1px solid #f2b9cf;padding:10px 14px;border-radius:12px;color:#6a3e57;font-weight:800;zIndex:100';
      warn.textContent='Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©. Ø§ÙØªØ­ Console Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„.';
      document.body.appendChild(warn);
    }

    // ===== Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©) =====
    try{
      // 1) setTool ÙŠÙØ¹Ù‘Ù„ Ø²Ø± Ø§Ù„Ø³Ù‚ÙŠ
      setTool('WATER'); console.assert(document.querySelector('#tool-water').classList.contains('active'), 'Ø²Ø± Ø§Ù„Ø³Ù‚ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØµØ¨Ø­ Active');
      setTool('PLANT');
      // 2) Ø¥Ù† ÙƒØ§Ù† Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„ Ø§Ù„Ù‚Ø·Ø¹ ÙØ§Ø±ØºØ© (18)
      if(window.__firstRun){
        const emptyCount = state.plots.filter(p=>p.empty===true).length;
        console.assert(emptyCount===18, 'ÙÙŠ Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ø¯Ø£ ÙƒÙ„ Ù‚Ø·Ø¹ Ø§Ù„ØªØ±Ø¨Ø© ÙØ§Ø¶ÙŠØ© (18/18)');
      }
      // 3) Ù…Ø­Ø§ÙƒØ§Ø© Ø²Ø±Ø¹ Ù…Ø¤Ù‚Øª Ø«Ù… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©
      const snapshot = JSON.stringify(state.plots);
      state.plots[0] = {empty:false,type:'rose',stage:0,water:0}; renderGarden();
      console.assert(document.querySelector('#garden .plot .seed'), 'ÙŠØ¬Ø¨ Ø¸Ù‡ÙˆØ± Ø¨Ø°Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø²Ø±Ø¹');
      state.plots = JSON.parse(snapshot); renderGarden();
      // 4) Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ¯ÙŠØ±
      console.assert(typeof exportBouquetPNG === 'function', 'exportBouquetPNG ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ù„Ø©');
    }catch(testErr){ console.warn('Self-tests failed:', testErr); }

  });
  </script>
</body>
</html>



